{% extends 'core/base.html' %}
{% load static %}

{% block title %}Cat√°logo | Dulce Arte{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'core/css/catalogo.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
  /* Chips de categor√≠a */
  .chip {
    display:inline-block; padding:.5rem .9rem; border-radius:999px;
    border:1px solid #ddd; background:#fff; color:#4b2c20; text-decoration:none;
  }
  .chip.active { background:#a4d04f; color:#fff; border-color:#8ac244; }
  .chip:hover { text-decoration:none; filter:brightness(0.98); }
</style>
{% endblock %}

{% block content %}
<section class="catalogo py-5">
  <div class="container">
    <hr>

    <!-- üßÅ T√≠tulo y bot√≥n nuevo producto -->
    <div class="d-flex justify-content-between align-items-center mb-5">
      <h1 class="cat-title m-0">üç∞ Cat√°logo de productos</h1>

      {% if request.user.is_staff %}
      <a href="{% url 'crear_producto' %}" class="btn-add d-flex align-items-center gap-2" style="text-decoration:none;">
        <i class="bi bi-plus-circle"></i> Nuevo producto
      </a>
      {% endif %}
    </div>

    <!-- üîé Filtros (chips + b√∫squeda) -->
    <div class="d-flex flex-wrap align-items-center gap-2 mb-4">
      <a href="{% url 'productos' %}"
         class="chip {% if not categoria_seleccionada %}active{% endif %}">
        Todas
      </a>

      {% for c in categorias %}
        <a href="{% url 'productos' %}?categoria={{ c.id }}{% if q %}&q={{ q|urlencode }}{% endif %}"
           class="chip {% if categoria_seleccionada and c.id == categoria_seleccionada.id %}active{% endif %}">
          {{ c.nombre }}
        </a>
      {% endfor %}

      <form method="get" class="ms-auto d-flex gap-2">
        {% if categoria_seleccionada %}
          <input type="hidden" name="categoria" value="{{ categoria_seleccionada.id }}">
        {% endif %}
        <input type="search" class="form-control" name="q" value="{{ q }}" placeholder="Buscar producto‚Ä¶">
        <button class="btn btn-cta">Buscar</button>
      </form>
    </div>

    <!-- üßÅ Grid de productos -->
    <div class="cat-grid">
      {% for p in productos %}
      <article class="prod-card shadow-sm">
        <div class="prod-inner">
          
          <!-- üì∏ Imagen del producto -->
          <div class="prod-media">
            {% if p.imagen %}
              <img src="{{ p.imagen.url }}" alt="{{ p.nombre }}">
            {% else %}
              <img src="{% static 'img/placeholder-pastry.png' %}" alt="{{ p.nombre }}">
            {% endif %}
          </div>

          <!-- üì¶ Contenido del producto -->
          <div class="prod-body">
            <span class="badge bg-secondary mb-2">{{ p.categoria.nombre }}</span>
            <h3 class="prod-name">{{ p.nombre }}</h3>
            <div class="prod-price">${{ p.precio|floatformat:0 }}</div>

            <!-- üõí Grupo de acciones -->
            <div class="mt-3 d-flex flex-column gap-2">

              <!-- üõí A√±adir al carrito -->
              <form method="post" action="{% url 'agregar_al_carrito' p.id %}">
                {% csrf_token %}
                <button class="btn-add w-100" type="submit">
                  <i class="bi bi-cart-plus"></i> A√±adir al carrito
                </button>
              </form>

              {% if request.user.is_staff %}
              <!-- ‚úèÔ∏è y üóëÔ∏è solo visibles para admin -->
              <div class="d-flex gap-2 justify-content-between">

                <!-- ‚úèÔ∏è Actualizar producto -->
                <a href="{% url 'actualizar_producto' p.id %}" class="btn-add w-50 text-center" style="text-decoration:none;">
                  <i class="bi bi-pencil-square"></i> Actualizar
                </a>

                <!-- üóëÔ∏è Eliminar producto -->
                <form action="{% url 'eliminar_producto' p.id %}" method="post" class="w-50" onsubmit="return confirm('¬øEst√°s seguro de eliminar este producto?');">
                  {% csrf_token %}
                  <button type="submit" class="btn-add w-100" style="background-color:#d9534f;">
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                </form>

              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </article>
      {% empty %}
        <p class="text-center">No hay productos disponibles{% if categoria_seleccionada %} en esta categor√≠a{% endif %}{% if q %} para ‚Äú{{ q }}‚Äù{% endif %}.</p>
      {% endfor %}
    </div>

  </div>
</section>
{% endblock %}

