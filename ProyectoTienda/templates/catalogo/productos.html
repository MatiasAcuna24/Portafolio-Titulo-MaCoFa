{% extends 'core/base.html' %}
{% load static %}

{% block title %}Cat√°logo | Dulce Arte{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'core/css/catalogo.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
  /* Chips de categor√≠a */
  .chip {
    display:inline-block; padding:.5rem .9rem; border-radius:999px;
    border:1px solid #ddd; background:#fff; color:#4b2c20; text-decoration:none;
  }
  .chip.active { background:#a4d04f; color:#fff; border-color:#8ac244; }
  .chip:hover { text-decoration:none; filter:brightness(0.98); }

  /* Promociones */
  .promo-card {
    background:#fffdf5;
    border:1px solid #eee;
    border-radius:1rem;
    padding:1.2rem;
    text-align:center;
    transition:all 0.3s ease-in-out;
  }
  .promo-card:hover { transform:translateY(-3px); box-shadow:0 6px 14px rgba(0,0,0,0.1); }
  .promo-card h5 { color:#6fbf3e; font-weight:700; }
  .promo-card p { margin:0; color:#4b2c20; }
  .promo-card small { color:#a8a8a8; }

  /* Precio */
  .prod-price { font-size:1.2rem; }
  .text-success { color:#6fbf3e!important; }
</style>
{% endblock %}

{% block content %}
<section class="catalogo py-5">
  <div class="container">
    <hr>

    <!-- üéÅ Promociones activas -->
    {% if promociones %}
    <div class="mb-5">
      <h2 class="text-center fw-bold mb-4" style="color:#4b2c20;">Promociones vigentes</h2>
      <div class="row justify-content-center g-3">
        {% for promo in promociones %}
        <div class="col-md-3 col-sm-6">
          <div class="promo-card">
            <h5>{{ promo.nombre }}</h5>
            <p>{{ promo.descripcion }}</p>
            <p class="fw-bold mt-2">
              {% if promo.tipo == 'percent' %}
                {{ promo.valor|floatformat:0 }}% de descuento
              {% else %}
                ${{ promo.valor|floatformat:0 }} CLP de descuento
              {% endif %}
            </p>
            {% if promo.fecha_fin %}
              <small>V√°lido hasta {{ promo.fecha_fin|date:"d/m/Y" }}</small>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- üßÅ T√≠tulo -->
    <div class="d-flex justify-content-between align-items-center mb-5">
      <h1 class="cat-title m-0">üç∞ Cat√°logo de productos</h1>

      {% if request.user.is_staff %}
      <a href="{% url 'crear_producto' %}" class="btn-add d-flex align-items-center gap-2" style="text-decoration:none;">
        <i class="bi bi-plus-circle"></i> Nuevo producto
      </a>
      {% endif %}
    </div>

    <!-- üîé Filtros -->
    <div class="d-flex flex-wrap align-items-center gap-2 mb-4">
      <a href="{% url 'productos' %}"
         class="chip {% if not categoria_seleccionada %}active{% endif %}">
        Todas
      </a>

      {% for c in categorias %}
        <a href="{% url 'productos' %}?categoria={{ c.id }}{% if q %}&q={{ q|urlencode }}{% endif %}"
           class="chip {% if categoria_seleccionada and c.id == categoria_seleccionada.id %}active{% endif %}">
          {{ c.nombre }}
        </a>
      {% endfor %}

      <form method="get" class="ms-auto d-flex gap-2">
        {% if categoria_seleccionada %}
          <input type="hidden" name="categoria" value="{{ categoria_seleccionada.id }}">
        {% endif %}
        <input type="search" class="form-control" name="q" value="{{ q }}" placeholder="Buscar producto‚Ä¶">
        <button class="btn btn-cta">Buscar</button>
      </form>
    </div>

    <!-- üßÅ Grid de productos -->
    <div class="cat-grid">
      {% for p in productos %}
      <article class="prod-card shadow-sm">
        <div class="prod-inner">
          
          <!-- üì∏ Imagen -->
          <div class="prod-media">
            {% if p.imagen %}
              <img src="{{ p.imagen.url }}" alt="{{ p.nombre }}">
            {% else %}
              <img src="{% static 'img/placeholder-pastry.png' %}" alt="{{ p.nombre }}">
            {% endif %}
          </div>

          <!-- üì¶ Info -->
          <div class="prod-body">
            <span class="badge bg-secondary mb-2">{{ p.categoria.nombre }}</span>
            <h3 class="prod-name">{{ p.nombre }}</h3>

            <!-- üí∏ Precio con descuento -->
            <p class="prod-price">
              {% if p.precio_con_descuento < p.precio %}
                <span class="text-muted text-decoration-line-through">${{ p.precio|floatformat:0 }}</span>
                <span class="fw-bold text-success ms-1">${{ p.precio_con_descuento|floatformat:0 }}</span>
              {% else %}
                <span class="fw-bold">${{ p.precio|floatformat:0 }}</span>
              {% endif %}
            </p>

            <!-- üõí Acciones -->
            <div class="mt-3 d-flex flex-column gap-2">
              <a href="{% url 'detalle_producto' p.id %}" class="btn btn-add w-100">
                Ver detalle
              </a>

              {% if request.user.is_staff %}
              <div class="d-flex gap-2 justify-content-between">
                <!-- ‚úèÔ∏è Editar -->
                <a href="{% url 'actualizar_producto' p.id %}" class="btn-add w-50 text-center" style="text-decoration:none;">
                  <i class="bi bi-pencil-square"></i> Actualizar
                </a>

                <!-- üóëÔ∏è Eliminar -->
                <form action="{% url 'eliminar_producto' p.id %}" method="post" class="w-50"
                      onsubmit="return confirm('¬øEst√°s seguro de eliminar este producto?');">
                  {% csrf_token %}
                  <button type="submit" class="btn-add w-100" style="background-color:#d9534f;">
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                </form>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </article>
      {% empty %}
        <p class="text-center">No hay productos disponibles{% if categoria_seleccionada %} en esta categor√≠a{% endif %}{% if q %} para ‚Äú{{ q }}‚Äù{% endif %}.</p>
      {% endfor %}
    </div>
  </div>
</section>
{% endblock %}
